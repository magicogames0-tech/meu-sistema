import os
import sqlite3

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DB_PATH = os.path.join(BASE_DIR, "agenda.db")

# Se o arquivo existir mas não for um banco válido, remove
if os.path.exists(DB_PATH):
    try:
        conn = sqlite3.connect(DB_PATH)
        conn.execute("PRAGMA schema_version;")
        conn.close()
    except sqlite3.DatabaseError:
        os.remove(DB_PATH)  # deleta arquivo corrompido

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("""
    CREATE TABLE IF NOT EXISTS clientes (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        nome TEXT NOT NULL,
        telefone TEXT
    )
    """)
    c.execute("""
    CREATE TABLE IF NOT EXISTS agendamentos (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        cliente_id INTEGER,
        data TEXT,
        hora TEXT,
        status TEXT DEFAULT 'ativo',
        FOREIGN KEY (cliente_id) REFERENCES clientes (id)
    )
    """)
    conn.commit()
    conn.close()
